# Full End-to-End Automated Terraform Pipeline with Bells & Whistles
# Deploy to AWS via GitHub Actions | Multi-Env | Security | Cost | Alerts | Rollback

name: ðŸš€ Full Terraform Auto-Deploy

on:
  push:
    branches: [ main ]
    paths: [ 'terraform/**' ]
  pull_request:
    paths: [ 'terraform/**' ]

env:
  TF_VERSION: '1.9.5'
  REQUIRED_LABEL: 'approved'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      - name: Terraform Format
        run: terraform fmt -check -recursive terraform/
      - name: Terraform Validate
        run: terraform validate -recursive terraform/
      - name: Security Scan (tfsec)
        uses: aquasecurity/tfsec-action@v1
        with:
          path: terraform/
      - name: IaC Scan (Checkov)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform/
          framework: terraform

  plan:
    needs: validate
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [ dev, staging, prod ]
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      - name: Terraform Init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets[format('{0}_AWS_ACCESS_KEY_ID', upper(matrix.env))] }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets[format('{0}_AWS_SECRET_ACCESS_KEY', upper(matrix.env))] }}
        run: |
          cd terraform
          terraform init -backend-config="bucket=${{ secrets[format('{0}_TF_STATE_BUCKET', upper(matrix.env))] }}" \
                         -backend-config="key=env/${{ matrix.env }}/terraform.tfstate" \
                         -backend-config="region=${{ secrets.AWS_REGION }}" \
                         -backend-config="dynamodb_table=${{ secrets.TF_LOCK_TABLE }}"
      - name: Terraform Plan
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets[format('{0}_AWS_ACCESS_KEY_ID', upper(matrix.env))] }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets[format('{0}_AWS_SECRET_ACCESS_KEY', upper(matrix.env))] }}
        id: plan
        run: |
          cd terraform
          terraform plan -var="environment=${{ matrix.env }}" -out=tfplan
        continue-on-error: true
      - name: Cost Estimation (Infracost)
        if: matrix.env == 'prod'
        uses: infracost/actions/infracost@latest
        env:
          INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }}
        with:
          path: terraform/
          project-id: enterprise-infra
      - name: Update PR Comment (Plan)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### ${{ matrix.env }} Environment Plan ðŸŽ¯\n${{ steps.plan.outputs.stdout }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  security-approval:
    needs: plan
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.GITHUB_TOKEN }}
          approvers: garrettc123
          minimum-approvals: 1
          issue-title: 'Review Terraform Security & Cost'

  apply:
    needs: [ plan, security-approval ]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [ dev, staging, prod ]
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - name: Terraform Init
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets[format('{0}_AWS_ACCESS_KEY_ID', upper(matrix.env))] }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets[format('{0}_AWS_SECRET_ACCESS_KEY', upper(matrix.env))] }}
        run: |
          cd terraform
          terraform init
      - name: Terraform Apply
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets[format('{0}_AWS_ACCESS_KEY_ID', upper(matrix.env))] }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets[format('{0}_AWS_SECRET_ACCESS_KEY', upper(matrix.env))] }}
        run: |
          cd terraform
          terraform apply -auto-approve tfplan
      - name: Outputs & Slack Alert
        if: success()
        uses: 8398a7/action-slack@v3
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
          text: 'Terraform âœ… Deployed to ${{ matrix.env }}'

  rollback:
    needs: apply
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Auto-Rollback
        run: |
          echo 'Rollback triggered - Restore previous state'
          # Custom rollback logic here
      - uses: 8398a7/action-slack@v3
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        with:
          status: failure
          text: 'ðŸš¨ Terraform Rollback Executed'

  copilot-review:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Assign Copilot
        uses: github/copilot-assign-action@v1
        with:
          issueNumber: ${{ github.event.pull_request.number }}
