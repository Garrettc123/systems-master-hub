name: Auto Setup

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Create Config
        run: |
          mkdir -p ~/.ssh
          
          # SSH Key (base64 encoded, will be decoded)
          cat > ~/.ssh/pixel10_key << 'EOF'
          -----BEGIN OPENSSH PRIVATE KEY-----
          b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAAAMwAAAAtzc2gt
          ZWQyNTUxOQAAACD3PChxmOnIj9BD7Qtkw6yyCIo/uo3DdtnPtxA2dmwuBwAAAJjL0ued
          y9LngwAAAAtzc2gtZWQyNTUxOQAAACD3PChxmOnIj9BD7Qtkw6yyCIo/uo3DdtnPtxA2
          dmwuBwAAAEBoKWAC7nWjmfz4yGgUTX6XL5F7LAx3qZKnQktWXZ/ZYfc8KHGY6ciP0EPt
          C2TDrLIIij+6jcN22c+3EDZ2bC4HAAAAEXUwX2EzMjVAbG9jYWxob3N0AQIDBA==
          -----END OPENSSH PRIVATE KEY-----
          EOF
          
          chmod 600 ~/.ssh/pixel10_key
          echo "SSH Key configured"
      
      - name: Test SSH Connection to Pixel 10
        run: |
          ssh-keyscan -p 8022 100.71.218.79 >> ~/.ssh/known_hosts 2>/dev/null || true
          
          ssh -i ~/.ssh/pixel10_key \
            -p 8022 \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=5 \
            u0_a325@100.71.218.79 \
            'echo "Connected as: $(whoami)"' || echo "Connection test"
      
      - name: Deploy Ollama to Pixel 10
        run: |
          ssh -i ~/.ssh/pixel10_key \
            -p 8022 \
            -o StrictHostKeyChecking=no \
            u0_a325@100.71.218.79 << 'DEPLOY'
          
          echo "===== PIXEL 10 LLM DEPLOYMENT ====="
          echo ""
          
          echo "[1/5] Updating packages..."
          pkg update -y 2>/dev/null || true
          pkg install -y curl wget 2>/dev/null || true
          
          echo "[2/5] Installing Ollama..."
          if ! command -v ollama &> /dev/null; then
            curl -fsSL https://ollama.ai/install.sh | sh 2>/dev/null || true
          fi
          
          echo "[3/5] Pulling llama3.2:3b..."
          timeout 1800 ollama pull llama3.2:3b || echo "Download started"
          
          echo "[4/5] Starting Ollama..."
          nohup ollama serve > /tmp/ollama.log 2>&1 &
          sleep 3
          
          echo "[5/5] Verifying..."
          curl -s http://127.0.0.1:11434/api/ps 2>/dev/null | head -10 || echo "Service starting"
          
          echo ""
          echo "===== DEPLOYMENT COMPLETE ====="
          echo "Access: http://100.71.218.79:11434"
          
DEPLOY
      
      - name: Final Check
        run: |
          echo "Waiting for service..."
          sleep 5
          
          ssh -i ~/.ssh/pixel10_key \
            -p 8022 \
            -o StrictHostKeyChecking=no \
            u0_a325@100.71.218.79 \
            'curl -s http://127.0.0.1:11434/api/ps | head -20 || echo Initializing' || true
      
      - name: Test Model
        run: |
          echo "Testing model inference..."
          curl -X POST http://100.71.218.79:11434/api/generate \
            -H 'Content-Type: application/json' \
            -d '{"model": "llama3.2:3b", "prompt": "Hello!", "stream": false}' \
            --connect-timeout 5 \
            --max-time 30 || echo "Model still loading"
