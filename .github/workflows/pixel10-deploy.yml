name: Deploy Pixel 10 LLM Platform

on:
  workflow_dispatch:
    inputs:
      device_ip:
        description: 'Device IP Address'
        required: true
        default: '100.71.218.79'
      ssh_port:
        description: 'SSH Port'
        required: true
        default: '8022'
      dry_run:
        description: 'Dry run (true/false)'
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Pixel 10
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Pre-flight Check
        run: |
          echo "Device IP: ${{ github.event.inputs.device_ip }}"
          echo "SSH Port: ${{ github.event.inputs.ssh_port }}"
          echo "Dry Run: ${{ github.event.inputs.dry_run }}"
          
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PIXEL10_SSH_KEY }}" > ~/.ssh/pixel10_key
          chmod 600 ~/.ssh/pixel10_key
          ssh-keyscan -p ${{ github.event.inputs.ssh_port }} ${{ github.event.inputs.device_ip }} >> ~/.ssh/known_hosts 2>/dev/null || echo "SSH key scan skipped"
          
      - name: Test Connection
        run: |
          echo "Testing SSH connection..."
          ssh -i ~/.ssh/pixel10_key -p ${{ github.event.inputs.ssh_port }} -o ConnectTimeout=10 -o StrictHostKeyChecking=no u0_a325@${{ github.event.inputs.device_ip }} "echo SSH Connection OK" || echo "Connection test inconclusive"
          
      - name: Deploy Ollama
        if: github.event.inputs.dry_run == 'false'
        run: |
          echo "Deploying Ollama to device..."
          ssh -i ~/.ssh/pixel10_key -p ${{ github.event.inputs.ssh_port }} -o StrictHostKeyChecking=no u0_a325@${{ github.event.inputs.device_ip }} bash << 'DEPLOY_SCRIPT'
          set -e
          echo "[1/6] Installing packages..."
          pkg install -y curl wget openssl openssh
          echo "[2/6] Installing Ollama..."
          curl -fsSL https://ollama.ai/install.sh | sh || true
          echo "[3/6] Downloading model..."
          timeout 1200 ollama pull llama3.2:3b || echo "Model download in progress"
          echo "[4/6] Starting service..."
          ollama serve &
          sleep 5
          echo "[5/6] Testing..."
          curl -s http://127.0.0.1:11434/api/ps || echo "Service starting"
          echo "[6/6] Complete"
          DEPLOY_SCRIPT
          
      - name: Verify Deployment
        if: github.event.inputs.dry_run == 'false'
        run: |
          echo "Verifying..."
          ssh -i ~/.ssh/pixel10_key -p ${{ github.event.inputs.ssh_port }} -o StrictHostKeyChecking=no u0_a325@${{ github.event.inputs.device_ip }} "curl -s http://127.0.0.1:11434/api/ps || echo Verifying" || true
          
      - name: Upload Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: deployment-report
          path: deployment-report.md
          retention-days: 30
